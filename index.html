<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mitoverse Passport</title>
  <style>
    /* Basic reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .passport-container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 24px;
      width: 360px;
      text-align: center;
    }

    #passport {
      margin: 16px auto;
      width: 320px;
      height: 200px;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      position: relative;
      overflow: hidden;
    }

    #passport canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .btn {
      margin-top: 16px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #667eea;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #5a67d8;
    }
  </style>
</head>
<body>
  <div class="passport-container">
    <h2>Mitoverse Passport</h2>
    <button id="connectBtn" class="btn">Connect Wallet</button>
    <div id="passport">
      <canvas id="passportCanvas"></canvas>
    </div>
    <button id="mintBtn" class="btn" disabled>Mint Passport</button>
  </div>

  <script>
    const connectBtn = document.getElementById('connectBtn');
    const mintBtn = document.getElementById('mintBtn');
    const canvas = document.getElementById('passportCanvas');
    const ctx = canvas.getContext('2d');

    let userAddress = null;
    let chainList = [];
    let transferCount = 0;

    // Resize canvas to fit container
    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

  // Draw user passport data
function drawPassport() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
  ctx.fillRect(10, 10, canvas.width - 20, canvas.height - 20);

  ctx.fillStyle = 'white';
  ctx.font = '16px sans-serif';
  ctx.fillText('Address: ' + (userAddress || '—'), 20, 40);
  ctx.fillText('Chains: ' + (chainList.join(', ') || '—'), 20, 70);
  ctx.fillText('Transfers: ' + transferCount, 20, 100);

  // TODO: add avatar rendering
  ctx.beginPath();
  ctx.arc(canvas.width - 50, 40, 20, 0, Math.PI * 2);
  ctx.fillStyle = '#ffffff55';
  ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.font = '12px sans-serif';
  ctx.fillText('YOU', canvas.width - 65, 45);
}

// Connect wallet
connectBtn.addEventListener('click', async () => {
  if (!window.ethereum) {
    alert('Please install MetaMask');
    return;
  }

  try {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    const network = await provider.getNetwork();
    const chainId = network.chainId;

    // Detect chain name (customize for Mitosis)
    const chainNames = {
      1: 'Ethereum',
      42161: 'Arbitrum',
      9999: 'Mitosis' // Replace 9999 with actual Mitosis chain ID
    };
    const currentChain = chainNames[chainId] || `Chain ${chainId}`;
    chainList = [currentChain];

    // Fetch number of Transfer logs (simplified)
    const transferTopic = ethers.id("Transfer(address,address,uint256)");

    const logs = await provider.getLogs({
      fromBlock: 0,
      toBlock: 'latest',
      topics: [transferTopic, null, null],
      address: userAddress
    });

    transferCount = logs.length;

    drawPassport();
    mintBtn.disabled = false;
    connectBtn.textContent = 'Connected';
  } catch (err) {
    console.error(err);
    alert('Failed to connect wallet or fetch data.');
  }
});

// Mint passport
mintBtn.addEventListener('click', () => {
  const dataURL = canvas.toDataURL('image/png');
  console.log('Ready to mint with data:', dataURL);

  // Placeholder: upload image to IPFS or backend before minting
  alert('Minting flow goes here (upload to IPFS and call smart contract)');
});

// Initial render
drawPassport();
    
  </script>
</body>
</html>